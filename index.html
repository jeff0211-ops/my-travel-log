<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Travel Archive</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --primary: #0984e3; --dark: #2d3436; --bg: #f5f7fa; --white: #ffffff; }
        * { font-family: 'Pretendard', sans-serif !important; box-sizing: border-box; letter-spacing: -0.5px; }
        body { background: var(--bg); margin: 0; padding: 20px; color: var(--dark); line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; padding: 30px 0; }
        .header h1 { font-size: 2.2rem; margin: 0; font-weight: 800; color: var(--primary); cursor: pointer; display: inline-block; }
        .header p { color: #636e72; margin-top: 8px; font-weight: 500; font-size: 1.1rem; }
        .btn-toggle-form { background: var(--primary); color: white; border: none; padding: 14px 28px; border-radius: 50px; font-weight: 700; cursor: pointer; display: block; margin: 0 0 25px auto; box-shadow: 0 4px 15px rgba(9, 132, 227, 0.3); transition: 0.2s; }
        #form-container { display: none; background: var(--white); border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 30px; border: 1px solid #edf2f7; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
        .full { grid-column: span 2; }
        label { display: block; margin-bottom: 8px; font-size: 0.85rem; font-weight: 700; color: #4a5568; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 14px; font-size: 14px; background: #fdfdfd; }
        
        .editor-container { border: 1px solid #e2e8f0; border-radius: 14px; background: #fdfdfd; overflow: hidden; }
        .editor-toolbar { padding: 10px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .editor-toolbar button { background: white; border: 1px solid #ddd; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; color: var(--dark); }
        .color-palette { display: flex; gap: 4px; margin-left: 2px; border-left: 1px solid #ddd; padding-left: 8px; flex-wrap: wrap; }
        .color-btn { width: 22px; height: 22px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
        
        .symbol-palette { display: flex; gap: 4px; margin-left: 2px; border-left: 1px solid #ddd; padding-left: 8px; flex-wrap: wrap; }
        .symbol-btn { background: #fff !important; border: 1px solid #ddd !important; padding: 4px 10px !important; border-radius: 4px !important; cursor: pointer; font-size: 14px !important; color: #2d3436; min-width: 32px; }
        .symbol-btn:hover { background: #edf2f7 !important; }

        /* [ìˆ˜ì • 2] í¸ì§‘ í›„ ìŠ¤í¬ë¡¤ ë¨¹í†µ í˜„ìƒ í•´ê²°ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ë³´ì™„ */
        .rich-editor { 
            height: 200px !important; padding: 14px; 
            overflow-y: auto !important; 
            -webkit-overflow-scrolling: touch !important; 
            touch-action: pan-y !important; /* í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©í–¥ ê³ ì •ìœ¼ë¡œ ê°„ì„­ ìµœì†Œí™” */
            font-size: 14px; outline: none; display: block;
            word-break: break-all;
        }
        .rich-editor::-webkit-scrollbar { width: 10px; display: block; }
        .rich-editor::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 0 14px 14px 0; }
        .rich-editor::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; border: 2px solid #f1f1f1; }
        .rich-editor::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        .rich-editor[contenteditable]:empty:before { content: attr(placeholder); color: #a0aec0; cursor: text; }
        
        .btn-submit { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 14px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 20px; }
        .filter-area { background: #fff; padding: 15px; border-radius: 22px; margin-bottom: 25px; border: 1px solid #edf2f7; box-shadow: 0 4px 15px rgba(0,0,0,0.04); }
        .filter-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px; }
        .filter-row select { padding: 10px 2px; font-size: clamp(10px, 3.2vw, 13px); text-align: center; border-radius: 12px; background: #f8fafc; border: 1px solid #eee; appearance: none; }
        .search-row { display: flex; gap: 8px; }
        .search-row input { flex: 1; height: 46px; border-radius: 23px; padding-left: 18px; border: 1px solid #e2e8f0; font-size: 14px; }
        .btn-search { width: 46px; height: 46px; background: var(--primary); color: white; border: none; border-radius: 50%; cursor: pointer; }
        .post-item { background: var(--white); border-radius: 20px; margin-bottom: 15px; border: 1px solid #edf2f7; overflow: hidden; }
        .post-header { padding: 22px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .tag { padding: 5px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 800; margin-right: 10px; }
        .tag-food { background: #fff3e0; color: #e65100; }
        .tag-tour { background: #e3f2fd; color: #1976d2; }
        .tag-stay { background: #f3e5f5; color: #7b1fa2; }
        .post-content { display: none; padding: 25px; background: #fafbfc; border-top: 1px solid #f1f3f6; }
        .detail-card { background: #fff; border: 1px solid #edf2f7; border-radius: 15px; padding: 18px; margin-bottom: 12px; }
        .detail-label { font-size: 0.8rem; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
        .map-btn { display: inline-flex; align-items: center; gap: 6px; background: #e1f0ff; color: #0984e3; padding: 8px 15px; border-radius: 10px; text-decoration: none; font-size: 0.85rem; font-weight: 700; margin-top: 10px; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 30px; margin-bottom: 40px; }
        .page-btn { min-width: 38px; height: 38px; border-radius: 50%; border: 1px solid #e2e8f0; background: #fff; color: #718096; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 0 10px; }
        .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 10px rgba(9, 132, 227, 0.2); }
        .arrow-text-btn { border-radius: 12px; min-width: 70px; background: #eef2f7; color: var(--primary); border: none; font-size: 0.85rem; }
        
        @media screen and (max-width: 480px) { 
            .editor-toolbar { gap: 8px; }
            .symbol-palette, .color-palette { border-left: none; padding-left: 0; margin-top: 5px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <h1 onclick="location.reload()">Family <span>Archive</span></h1>
        <p>ì–´ëŠ ë©‹ì§„ ë‚ , ìš°ë¦¬ ê°€ì¡±ì˜ ë°œìì·¨</p>
    </header>

    <button class="btn-toggle-form" onclick="toggleForm()" id="btnToggle"><i class="fas fa-magic"></i> ì†Œì¤‘í•œ ì¶”ì–µ ìƒˆê¸°ê¸°</button>

    <div id="form-container">
        <form id="tripForm">
            <div class="input-grid">
                <div>
                    <label>ì˜¤ëŠ˜ì˜ ì—¬ì •</label>
                    <select id="category" onchange="updateUI()">
                        <option value="ë¡œì»¬ ë§›ì§‘">ğŸ½ï¸ ì…ì´ ì¦ê±°ìš´ ë¡œì»¬ ë§›ì§‘</option>
                        <option value="ê´€ê´‘ ëª…ì†Œ">ğŸ›ï¸ ê°€ìŠ´ ì„¤ë ˆëŠ” ê´€ê´‘ ëª…ì†Œ</option>
                        <option value="ìˆ™ì†Œ">ğŸ¨ ê¿ˆê²° ê°™ì€ ìŠ¤í…Œì´</option>
                    </select>
                </div>
                <div id="title-area">
                    <label id="lbl-title">ìŒì‹ì  (ì—…ì²´ëª…)</label>
                    <input type="text" id="title" required placeholder="ì–´ë””ì„œ ë§›ìˆëŠ” ì‹œê°„ì„ ë³´ëƒˆë‚˜ìš”?">
                </div>
                <div><label>ë°©ë¬¸ êµ­ê°€</label><input type="text" id="country" required placeholder="ì˜ˆ: ëŒ€í•œë¯¼êµ­"></div>
                <div><label>ë°©ë¬¸ ì§€ì—­</label><input type="text" id="region" required placeholder="ì˜ˆ: ë¶€ì‚° í•´ìš´ëŒ€"></div>
                <div class="full">
                    <label>ì§€ë„ ì£¼ì†Œ</label>
                    <input type="text" id="address" placeholder="êµ¬ê¸€ ì§€ë„ ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì‹œë©´ ë‚˜ì¤‘ì— ì°¾ê¸° í¸í•´ìš”">
                </div>
                <div class="full" id="info1-area">
                    <label id="lbl-info1">ì¶”ì²œ ë©”ë‰´</label>
                    <input type="text" id="info1" placeholder="ìš°ë¦¬ ê°€ì¡±ì´ ê¼½ì€ ìµœê³ ì˜ ë©”ë‰´ëŠ”?">
                </div>
                <div class="full" id="info2-area">
                    <label id="lbl-info2">ìš°ë¦¬ì˜ ë¯¸ì‹ ê¸°ë¡</label>
                    <div class="editor-container">
                        <div class="editor-toolbar">
                            <button type="button" onmousedown="event.preventDefault(); execCmd('bold')">B</button>
                            <button type="button" onmousedown="event.preventDefault(); execCmd('underline')">U</button>
                            <div class="color-palette">
                                <div class="color-btn" style="background:#000000" onmousedown="event.preventDefault(); execCmd('foreColor', '#000000')" title="ê²€ì •"></div>
                                <div class="color-btn" style="background:#ff0000" onmousedown="event.preventDefault(); execCmd('foreColor', '#ff0000')" title="ë¹¨ê°•"></div>
                                <div class="color-btn" style="background:#0000ff" onmousedown="event.preventDefault(); execCmd('foreColor', '#0000ff')" title="íŒŒë‘"></div>
                                <div class="color-btn" style="background:#ffff00" onmousedown="event.preventDefault(); execCmd('foreColor', '#ffff00')" title="ë…¸ë‘"></div>
                                <div class="color-btn" style="background:#8b4513" onmousedown="event.preventDefault(); execCmd('foreColor', '#8b4513')" title="ê°ˆìƒ‰"></div>
                                <div class="color-btn" style="background:#008000" onmousedown="event.preventDefault(); execCmd('foreColor', '#008000')" title="ì´ˆë¡"></div>
                                <div class="color-btn" style="background:#800080" onmousedown="event.preventDefault(); execCmd('foreColor', '#800080')" title="ë³´ë¼"></div>
                            </div>
                            <div class="symbol-palette">
                                <button type="button" class="symbol-btn" onmousedown="event.preventDefault(); insertSymbol('>')">></button>
                                <button type="button" class="symbol-btn" onmousedown="event.preventDefault(); insertSymbol('*')">*</button>
                                <button type="button" class="symbol-btn" onmousedown="event.preventDefault(); insertSymbol('â€»')">â€»</button>
                                <button type="button" class="symbol-btn" onmousedown="event.preventDefault(); insertSymbol('â€¢')">â€¢</button>
                            </div>
                        </div>
                        <div id="info2" class="rich-editor" contenteditable="true" placeholder="ë§›ì˜ ê°ë™ì´ë‚˜ ê°€ì¡±ë“¤ì˜ ëŒ€í™”ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”"></div>
                    </div>
                </div>
                <div class="full">
                    <label>ê°€ì¡±ë“¤ì˜ ë§ˆìŒ ì ìˆ˜</label>
                    <select id="rating"></select>
                </div>
            </div>
            <button type="submit" class="btn-submit" id="btnSubmit">ì´ ìˆœê°„ì„ ê¸°ë¡í•˜ê¸°</button>
        </form>
    </div>

    <div class="filter-area">
        <div class="filter-row">
            <select id="fCat" onchange="resetAndFilter()"><option value="">ì „ì²´ ìœ í˜•</option><option value="ë¡œì»¬ ë§›ì§‘">ë§›ì§‘</option><option value="ê´€ê´‘ ëª…ì†Œ">ëª…ì†Œ</option><option value="ìˆ™ì†Œ">ìˆ™ì†Œ</option></select>
            <select id="fCou" onchange="resetAndFilter()"><option value="">êµ­ê°€ ì„ íƒ</option></select>
            <select id="fReg" onchange="resetAndFilter()"><option value="">ì§€ì—­ ì„ íƒ</option></select>
            <select id="fRat" onchange="resetAndFilter()">
                <option value="">í‰ì  ì „ì²´</option>
                <option value="5">â­â­â­â­â­ (5ì )</option>
                <option value="4">â­â­â­â­â†‘ (4ì â†‘)</option>
                <option value="3">â­â­â­â†‘ (3ì â†‘)</option>
                <option value="2">â­â­â†‘ (2ì â†‘)</option>
                <option value="1">â­â†‘ (1ì â†‘)</option>
            </select>
        </div>
        <div class="search-row">
            <input type="text" id="keyword" placeholder="ì¥ì†Œë‚˜ ê¸°ì–µì„ ê²€ìƒ‰í•´ ë³´ì„¸ìš”..." onkeypress="if(event.keyCode==13) resetAndFilter()">
            <button class="btn-search" onclick="resetAndFilter()"><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div id="list-container">ì—¬ì •ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
    <div id="pagination" class="pagination"></div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzOHtg5wp_zj03ScG0hwe9HpijqxB8joQJFiMQx_3WvtDFymTqxj511aH1RgaVFpi9F/exec'; 

    let masterData = [];
    let filteredData = [];
    let editMode = false;
    let editTarget = null;
    let currentPage = 1;
    const postsPerPage = 10;

    function execCmd(cmd, value = null) {
        const editor = document.getElementById('info2');
        editor.focus();
        document.execCommand(cmd, false, value);
    }

    function insertSymbol(sym) {
        const editor = document.getElementById('info2');
        editor.focus();
        document.execCommand('insertText', false, sym);
    }

    // [ìˆ˜ì • 1] ì™¸ë¶€ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° ì‹œ ì„œì‹ ì™„ì „ ì œê±° ë¡œì§
    document.getElementById('info2').addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.originalEvent || e).clipboardData.getData('text/plain');
        document.execCommand('insertText', false, text);
    });

    // í¸ì§‘ê¸° ìŠ¤í¬ë¡¤ ë°©í•´ ê¸ˆì§€ ë¡œì§
    document.getElementById('info2').addEventListener('touchmove', function(e) {
        e.stopPropagation();
    }, {passive: true});

    window.onload = function() {
        history.pushState(null, null, location.href);
        window.onpopstate = function() {
            const f = document.getElementById('form-container');
            if(f.style.display === 'block') {
                toggleForm();
                history.pushState(null, null, location.href);
            } else {
                if(confirm("í˜ì´ì§€ë¥¼ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    history.back();
                } else {
                    history.pushState(null, null, location.href);
                }
            }
        };
    };

    function updateUI() {
        const cat = document.getElementById('category').value;
        const lblTitle = document.getElementById('lbl-title');
        const inpTitle = document.getElementById('title');
        const lblInfo1 = document.getElementById('lbl-info1');
        const inpInfo1 = document.getElementById('info1');
        const lblInfo2 = document.getElementById('lbl-info2');
        const edtInfo2 = document.getElementById('info2');
        const selRating = document.getElementById('rating');

        if(cat === 'ë¡œì»¬ ë§›ì§‘') {
            lblTitle.innerText = "ìŒì‹ì  (ì—…ì²´ëª…)";
            inpTitle.placeholder = "ì˜ˆ: í˜¸ì´ì•ˆ ë°˜ë¯¸í”„ì—‰, ë¶€ì‚° ê°€ì•¼ë°€ë©´";
            lblInfo1.innerText = "ì¶”ì²œ ë©”ë‰´";
            inpInfo1.placeholder = "ì…ì•ˆ ê°€ë“ í–‰ë³µí–ˆë˜ ë² ìŠ¤íŠ¸ ë©”ë‰´ëŠ”?";
            lblInfo2.innerText = "ìš°ë¦¬ì˜ ë¯¸ì‹ ê¸°ë¡";
            edtInfo2.setAttribute('placeholder', "ë§›ì˜ ê°ë™ì´ë‚˜ ê°€ì¡±ë“¤ì˜ ëŒ€í™”ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”");
            selRating.innerHTML = `<option value="5">â­â­â­â­â­ ì¸ìƒ ìµœê³ ì˜ ë§›ì§‘!</option><option value="4">â­â­â­â­ ë‹¤ì‹œ ë°©ë¬¸í•˜ê³  ì‹¶ì€ ë§›</option><option value="3">â­â­â­ ê¸°ë¶„ ì¢‹ê²Œ ë¨¹ì—ˆìŠµë‹ˆë‹¤</option><option value="2">â­â­ ê¸°ëŒ€ì— ë¹„í•´ í‰ë²”í–ˆì–´ìš”</option><option value="1">â­ ì €í¬ ìŠ¤íƒ€ì¼ì€ ì•„ë‹ˆì—ˆì–´ìš”</option>`;
        } else if(cat === 'ê´€ê´‘ ëª…ì†Œ') {
            lblTitle.innerText = "ì—¬ì •ì˜ ëª©ì ì§€ (ëª…ì†Œ ì´ë¦„)";
            inpTitle.placeholder = "ì˜ˆ: ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€, í•´ìš´ëŒ€ ë°”ë‹·ê°€";
            lblInfo1.innerText = "ê°ë™ í¬ì¸íŠ¸";
            inpInfo1.placeholder = "ì–´ë–¤ ì¥ë©´ì´ ê°€ì¥ ê¸°ì–µì— ë‚¨ë‚˜ìš”?";
            lblInfo2.innerText = "í˜„ì¥ì˜ ê¸°ë¡";
            edtInfo2.setAttribute('placeholder', "ê·¸ê³³ì—ì„œ ëŠë‚€ ì„¤ë ˜ê³¼ ê°ë™ì„ ì ì–´ë³´ì„¸ìš”");
            selRating.innerHTML = `<option value="5">â­â­â­â­â­ í‰ìƒ ìŠì§€ ëª»í•  í’ê²½</option><option value="4">â­â­â­â­ ê°€ìŠ´ì´ íƒ íŠ¸ì´ëŠ” ì‹œê°„</option><option value="3">â­â­â­ ì¦ê±°ìš´ ì‚°ì±…ì´ì—ˆìŠµë‹ˆë‹¤</option><option value="2">â­â­ ì‚¬ëŒì— ë„ˆë¬´ ì¹˜ì˜€ì–´ìš”</option><option value="1">â­ ìƒê°ë³´ë‹¤ ì•„ì‰¬ìš´ ì—¬ì •</option>`;
        } else if(cat === 'ìˆ™ì†Œ') {
            lblTitle.innerText = "ê¿ˆê²° ê°™ì€ ìŠ¤í…Œì´ (ìˆ™ì†Œ ì´ë¦„)";
            inpTitle.placeholder = "ì˜ˆ: ì‹ ë¼ í˜¸í…”, ì—ì–´ë¹„ì•¤ë¹„ ë‹¤ë‚­";
            lblInfo1.innerText = "ìˆ™ì†Œ íƒ€ì… ë° ì •ë³´";
            inpInfo1.placeholder = "ì˜ˆ: 5ì„±ê¸‰ í˜¸í…”, ìˆ˜ì˜ì¥ ë¹Œë¼, ê°ì„± ìŠ¤í…Œì´";
            lblInfo2.innerText = "ìŠ¤í…Œì´ ë¦¬í¬íŠ¸";
            edtInfo2.setAttribute('placeholder', "ì•„ëŠ‘í–ˆë˜ ì¹¨êµ¬, ì¡°ì‹ì˜ ë§›, ì£¼ë³€ì˜ ë¶„ìœ„ê¸°ê¹Œì§€");
            selRating.innerHTML = `<option value="5">â­â­â­â­â­ ì—¬ê¸°ì„œ ì‚´ê³  ì‹¶ì–´ìš”!</option><option value="4">â­â­â­â­ ë‚´ ì§‘ ê°™ì€ í¸ì•ˆí•¨</option><option value="3">â­â­â­ í•˜ë£»ë°¤ ì˜ ì‰¬ì—ˆìŠµë‹ˆë‹¤</option><option value="2">â­â­ ì‹œì„¤ì´ ì¡°ê¸ˆ ì•„ì‰¬ì›Œìš”</option><option value="1">â­ ìœ„ìƒì´ ì‹¤ë§ìŠ¤ëŸ¬ì› ì–´ìš”</option>`;
        }
    }

    async function loadData(keepFilter = false) {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            // [ì¤‘ìš”] ìµœì‹ ê¸€ ìƒë‹¨ ì •ë ¬ ë¡œì§ (ì ˆëŒ€ ë³´ì¡´)
            masterData = data.sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0));
            updateFilters();
            if (keepFilter) {
                runFilter();
            } else {
                resetAndFilter();
            }
        } catch (e) { document.getElementById('list-container').innerText = "ì—¬ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."; }
    }

    function toggleForm() {
        const f = document.getElementById('form-container');
        const isHidden = f.style.display !== 'block';
        f.style.display = isHidden ? 'block' : 'none';
        document.getElementById('btnToggle').innerHTML = isHidden ? '<i class="fas fa-times"></i> ë‹«ê¸°' : '<i class="fas fa-magic"></i> ì†Œì¤‘í•œ ì¶”ì–µ ìƒˆê¸°ê¸°';
        if(isHidden && !editMode) {
            document.getElementById('tripForm').reset();
            document.getElementById('info2').innerHTML = '';
            updateUI();
        }
    }

    function resetAndFilter() {
        currentPage = 1;
        runFilter();
    }

    function runFilter() {
        const cat = document.getElementById('fCat').value;
        const cou = document.getElementById('fCou').value;
        const reg = document.getElementById('fReg').value;
        const rat = document.getElementById('fRat').value;
        const key = document.getElementById('keyword').value.trim().toLowerCase();

        filteredData = masterData.filter(d => {
            return (!cat || d.category === cat) && (!cou || d.country === cou) && (!reg || d.region === reg) && 
                   (!rat || parseInt(d.rating) >= parseInt(rat)) &&
                   (!key || (d.title && d.title.toLowerCase().includes(key)) || (d.info2 && d.info2.toLowerCase().includes(key)));
        });
        
        filteredData.sort((a, b) => Number(b.timestamp || 0) - Number(a.timestamp || 0));
        drawList();
    }

    function drawList() {
        const startIndex = (currentPage - 1) * postsPerPage;
        const endIndex = startIndex + postsPerPage;
        const itemsToShow = filteredData.slice(startIndex, endIndex);

        const container = document.getElementById('list-container');
        if(filteredData.length === 0) { 
            container.innerHTML = "<p style='text-align:center;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; 
            document.getElementById('pagination').innerHTML = "";
            return; 
        }

        container.innerHTML = itemsToShow.map((d, i) => {
            let addressHtml = d.address || '-';
            if (d.address) {
                const mapLink = d.address.includes('http') ? d.address : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.address)}`;
                addressHtml = `<div>${d.address}</div><a href="${mapLink}" target="_blank" class="map-btn"><i class="fas fa-map-marked-alt"></i> êµ¬ê¸€ ì§€ë„ì—ì„œ ìœ„ì¹˜ í™•ì¸</a>`;
            }

            let label1 = "ì£¼ìš” ê¸°ë¡", label2 = "ìš°ë¦¬ì˜ ê¸°ë¡";
            if(d.category === 'ë¡œì»¬ ë§›ì§‘') { label1 = "ì¶”ì²œ ë©”ë‰´"; label2 = "ìš°ë¦¬ì˜ ë¯¸ì‹ ê¸°ë¡"; }
            else if(d.category === 'ê´€ê´‘ ëª…ì†Œ') { label1 = "ê°ë™ í¬ì¸íŠ¸"; label2 = "í˜„ì¥ì˜ ê¸°ë¡"; }
            else if(d.category === 'ìˆ™ì†Œ') { label1 = "ìˆ™ì†Œ íƒ€ì… ë° ì •ë³´"; label2 = "ìŠ¤í…Œì´ ë¦¬í¬íŠ¸"; }

            return `
            <div class="post-item">
                <div class="post-header" onclick="toggleAccordion('detail-${i}')">
                    <div style="flex:1;">
                        <span class="tag ${d.category==='ë¡œì»¬ ë§›ì§‘'?'tag-food':d.category==='ìˆ™ì†Œ'?'tag-stay':'tag-tour'}">${d.category}</span>
                        <strong style="font-size:1.1rem;">${d.title}</strong>
                        <div style="font-size:0.85rem; color:#718096; margin-top:5px;"><i class="fas fa-map-marker-alt"></i> ${d.country} Â· ${d.region}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:#f1c40f; font-weight:800;">â­ ${d.rating}</div>
                        <div style="font-size:0.75rem; color:#a0aec0; margin-top:5px;">${d.date || ''}</div>
                    </div>
                </div>
                <div class="post-content" id="detail-${i}">
                    <div class="detail-card"><div class="detail-label">ğŸ“ ìœ„ì¹˜ ì •ë³´</div>${addressHtml}</div>
                    <div class="detail-card"><div class="detail-label">âœ¨ ${label1}</div>${d.info1 || '-'}</div>
                    <div class="detail-card"><div class="detail-label">ğŸ“ ${label2}</div><div style="white-space:pre-wrap;">${d.info2 || '-'}</div></div>
                    <div style="text-align:right; margin-top:20px;">
                        <button onclick="goEdit('${d.title.replace(/'/g, "\\'")}')" style="border:none; background:#edf2f7; color:#4a5568; padding:10px 18px; border-radius:10px; cursor:pointer; font-weight:700;">ê¸°ë¡ ìˆ˜ì •</button>
                        <button onclick="goDelete('${d.title.replace(/'/g, "\\'")}')" style="border:none; background:#fff5f5; color:#e53e3e; padding:10px 18px; border-radius:10px; cursor:pointer; margin-left:12px; font-weight:700;">ê¸°ë¡ ì‚­ì œ</button>
                    </div>
                </div>
            </div>`}).join('');
        
        drawPagination();
    }

    function drawPagination() {
        const totalPages = Math.ceil(filteredData.length / postsPerPage);
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = "";
        if (totalPages <= 1) return;

        const prevBtn = document.createElement('button');
        prevBtn.innerText = '< ì´ì „';
        prevBtn.className = 'page-btn arrow-text-btn';
        prevBtn.disabled = (currentPage === 1);
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; drawList(); } };
        paginationContainer.appendChild(prevBtn);

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.innerText = i;
            btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            btn.onclick = () => { currentPage = i; drawList(); };
            paginationContainer.appendChild(btn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.innerText = 'ë‹¤ìŒ >';
        nextBtn.className = 'page-btn arrow-text-btn';
        nextBtn.disabled = (currentPage === totalPages);
        nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; drawList(); } };
        paginationContainer.appendChild(nextBtn);
    }

    function toggleAccordion(id) {
        const el = document.getElementById(id);
        const isShow = el.style.display === 'block';
        document.querySelectorAll('.post-content').forEach(c => c.style.display = 'none');
        el.style.display = isShow ? 'none' : 'block';
    }

    document.getElementById('tripForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit'); btn.disabled = true; btn.innerText = "ì†Œì¤‘íˆ ì €ì¥í•˜ëŠ” ì¤‘...";
        
        const now = new Date();
        const currentTimeMillis = now.getTime().toString();
        
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const displayTime = `${year}. ${month}. ${day}. ${hours}:${minutes}:${seconds}`;

        const payload = {
            action: editMode ? 'edit' : 'add',
            targetTitle: editTarget,
            data: {
                category: document.getElementById('category').value,
                title: document.getElementById('title').value,
                country: document.getElementById('country').value,
                region: document.getElementById('region').value,
                address: document.getElementById('address').value,
                info1: document.getElementById('info1').value,
                info2: document.getElementById('info2').innerHTML,
                rating: document.getElementById('rating').value,
                date: displayTime,
                timestamp: currentTimeMillis
            }
        };
        
        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            editMode = false;
            editTarget = null;
            toggleForm();
            loadData(false);
        } catch (error) {
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            btn.disabled = false;
            btn.innerText = "ì´ ìˆœê°„ì„ ê¸°ë¡í•˜ê¸°";
        }
    };

    function goEdit(t) {
        event.stopPropagation();
        const d = masterData.find(x => x.title === t);
        if(!d) return;
        document.getElementById('category').value = d.category;
        updateUI();
        document.getElementById('title').value = d.title;
        document.getElementById('country').value = d.country;
        document.getElementById('region').value = d.region;
        document.getElementById('address').value = d.address || '';
        document.getElementById('info1').value = d.info1 || '';
        document.getElementById('info2').innerHTML = d.info2 || '';
        document.getElementById('rating').value = d.rating;
        editMode = true; editTarget = t;
        if(document.getElementById('form-container').style.display !== 'block') toggleForm();
        document.getElementById('btnSubmit').innerText = "ìˆ˜ì • ì™„ë£Œ";
        window.scrollTo(0,0);
    }

    async function goDelete(t) {
        event.stopPropagation();
        if(!confirm(`ì†Œì¤‘í•œ ê¸°ë¡ì„ ì§€ìš¸ê¹Œìš”?`)) return;
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'delete', targetTitle:t}) });
        loadData(true);
    }

    function updateFilters() {
        const nations = [...new Set(masterData.map(d => d.country))].filter(Boolean).sort();
        const regions = [...new Set(masterData.map(d => d.region))].filter(Boolean).sort();
        document.getElementById('fCou').innerHTML = '<option value="">êµ­ê°€ ì„ íƒ</option>' + nations.map(n => `<option value="${n}">${n}</option>`).join('');
        document.getElementById('fReg').innerHTML = '<option value="">ì§€ì—­ ì„ íƒ</option>' + regions.map(r => `<option value="${r}">${r}</option>`).join('');
    }

    updateUI();
    loadData();
</script>
</body>
</html>