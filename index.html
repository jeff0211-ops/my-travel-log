<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ë¦¬ ê°€ì¡± ì—¬í–‰ ë„ê° V4.4</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --primary: #0984e3; --dark: #2d3436; --bg: #f5f7fa; --white: #ffffff; }
        * { font-family: 'Pretendard', -apple-system, sans-serif !important; letter-spacing: -0.3px !important; }
        body { background: var(--bg); margin: 0; padding: 20px; color: var(--dark); line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; padding: 20px 0; }
        .header h1 { font-size: 2rem; margin: 0; font-weight: 800; color: var(--primary); }
        .header p { color: #636e72; margin-top: 5px; }
        .toggle-btn-area { text-align: right; margin-bottom: 15px; }
        .btn-toggle-form { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3); }
        #form-container { display: none; }
        .main-card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #edf2f7; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full { grid-column: span 2; }
        label { display: block; margin-bottom: 8px; font-size: 0.85rem; font-weight: 600; color: #4a5568; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; box-sizing: border-box; background: #fdfdfd; }
        .btn-submit { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 20px; }
        
        .map-btn { display: inline-flex; align-items: center; gap: 8px; background: #f1f3f6; padding: 10px 16px; border-radius: 8px; color: #0984e3; text-decoration: none; font-weight: 600; font-size: 0.9rem; border: 1px solid #e2e8f0; margin-top: 5px; transition: 0.2s; }
        .map-btn i.fa-location-dot { color: #e74c3c; }

        .filter-area { background: #fff; padding: 15px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 20px; }
        
        /* [ìˆ˜ì • ë¶€ë¶„] í•„í„° ì˜ì—­: ë¬´ì¡°ê±´ í•œ ì¤„ ìœ ì§€ (5ì—´ ê³ ì •) */
        .filter-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .filter-row select { padding: 8px 4px; font-size: 14px; text-align: center; }

        /* [í•µì‹¬ ìˆ˜ì •] ëª¨ë°”ì¼ ì „ìš©: í™”ë©´ì´ 480px ì´í•˜ì¼ ë•Œ í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
        @media screen and (max-width: 480px) {
            .filter-row { gap: 3px; } /* ê°„ê²© ì¢í˜ */
            .filter-row select { 
                font-size: 11px !important; /* ê¸€ì í¬ê¸° ì¶•ì†Œ */
                padding: 8px 2px !important; /* ì¢Œìš° ì—¬ë°± ì¶•ì†Œ */
            }
        }

        .search-row { display: flex; gap: 8px; margin-top: 10px; }
        .search-row input { flex: 1; height: 45px; border-radius: 25px; padding-left: 20px; background: #f1f3f6; border: none; }
        .btn-search { width: 60px; height: 45px; background: var(--primary); color: white; border: none; border-radius: 25px; cursor: pointer; }
        .highlight { background-color: #fff176; font-weight: bold; border-radius: 2px; padding: 0 2px; }
        
        .post-item { background: var(--white); border-radius: 15px; margin-bottom: 12px; border: 1px solid #edf2f7; overflow: hidden; }
        .post-header { padding: 18px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; gap: 10px; }
        
        .tag { flex-shrink: 0; white-space: nowrap; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; display: inline-block; }
        .tag-food { background: #fff3e0; color: #e65100; }
        .tag-tour { background: #e3f2fd; color: #1976d2; }
        .tag-stay { background: #f3e5f5; color: #7b1fa2; }
        
        .post-content { display: none; padding: 25px; background: #fafbfc; border-top: 1px solid #f1f3f6; }
        .detail-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .detail-label { font-size: 0.8rem; font-weight: 700; color: var(--primary); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .post-meta { text-align: right; flex-shrink: 0; }
        .post-date { font-size: 0.7rem; color: #a0aec0; }
        .pager { display: flex; justify-content: center; gap: 8px; margin: 30px 0; min-height: 40px; }
        .page-num { width: 35px; height: 35px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-weight: bold; }
        .page-num.active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <h1>Family <span>Travel Log</span></h1>
        <p>ë¬´ì œí•œìœ¼ë¡œ ê¸°ë¡í•˜ëŠ” ìš°ë¦¬ ê°€ì¡± ë„ê°</p>
    </header>
    <div class="toggle-btn-area">
        <button class="btn-toggle-form" onclick="toggleForm()" id="btnToggle"><i class="fas fa-plus"></i> ìƒˆë¡œìš´ ì •ë³´ ê¸°ë¡í•˜ê¸°</button>
    </div>
    <div id="form-container">
        <div class="main-card">
            <form id="tripForm">
                <div class="input-grid">
                    <div><label>ìœ í˜•</label><select id="category" onchange="updateLabel()"><option value="ë¡œì»¬ ë§›ì§‘">ğŸ• ë¡œì»¬ ë§›ì§‘</option><option value="ê´€ê´‘ ëª…ì†Œ">ğŸ›ï¸ ê´€ê´‘ ëª…ì†Œ</option><option value="ìˆ™ì†Œ">ğŸ¨ ìˆ™ì†Œ</option></select></div>
                    <div><label id="nameLabel">ìŒì‹ì (ì—…ì²´ëª…)</label><input type="text" id="title" required></div>
                    <div><label>êµ­ê°€</label><input type="text" id="country" required></div>
                    <div><label>ì§€ì—­</label><input type="text" id="region" required></div>
                    <div class="full"><label>ìƒì„¸ ì£¼ì†Œ (ì…ë ¥ ì‹œ ì§€ë„ ë²„íŠ¼ ìƒì„±)</label><input type="text" id="address"></div>
                    <div class="full"><label id="recomLabel">ì¶”ì²œ ë©”ë‰´ ë° ë§›</label><input type="text" id="info1"></div>
                    <div class="full"><label id="memoLabel">ê°€ì¡±ë“¤ì˜ ìƒì„¸ ë©”ëª¨</label><textarea id="info2"></textarea></div>
                    <div class="full"><label>ê°€ì¡± í‰ì </label><select id="rating"><option value="5">â­â­â­â­â­</option><option value="4">â­â­â­â­</option><option value="3">â­â­â­</option><option value="2">â­â­</option><option value="1">â­</option></select></div>
                </div>
                <button type="submit" class="btn-submit" id="btnSubmit">ë„ê°ì— ë“±ë¡í•˜ê¸°</button>
            </form>
        </div>
    </div>
    <div class="filter-area">
        <div class="filter-row">
            <select id="fCat" onchange="runFilter()"><option value="">ìœ í˜•</option><option value="ë¡œì»¬ ë§›ì§‘">ë§›ì§‘</option><option value="ê´€ê´‘ ëª…ì†Œ">ê´€ê´‘</option><option value="ìˆ™ì†Œ">ìˆ™ì†Œ</option></select>
            <select id="fCou" onchange="runFilter()"><option value="">êµ­ê°€</option></select>
            <select id="fReg" onchange="runFilter()"><option value="">ì§€ì—­</option></select>
            <select id="fRat" onchange="runFilter()"><option value="">í‰ì </option><option value="5">5ì </option><option value="4">4ì â†‘</option></select>
        </div>
        <div class="search-row">
            <input type="text" id="keyword" placeholder="ì´ë¦„, ë‚´ìš©, ë©”ëª¨ ê²€ìƒ‰..." onkeypress="if(event.keyCode==13) runFilter()">
            <button class="btn-search" onclick="runFilter()"><i class="fas fa-search"></i></button>
        </div>
    </div>
    <div id="list-container">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    <div id="pager" class="pager"></div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyrVpAyHUclffUoB3VnpzdDYZ5IOXyU3Bf7ZD8mwdaEUcQ4bVlTBVFr54S7ssqt-0q1/exec'; 

    let masterData = [];
    let filteredData = [];
    let page = 1;
    const limit = 10;
    let editMode = false;
    let editTarget = null;

    function toggleForm() {
        const form = document.getElementById('form-container');
        const btn = document.getElementById('btnToggle');
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
        btn.innerHTML = form.style.display === 'block' ? '<i class="fas fa-times"></i> ì…ë ¥ì°½ ë‹«ê¸°' : '<i class="fas fa-plus"></i> ìƒˆë¡œìš´ ì •ë³´ ê¸°ë¡í•˜ê¸°';
    }

    function updateLabel() {
        const cat = document.getElementById('category').value;
        const nameLabel = document.getElementById('nameLabel');
        const recomLabel = document.getElementById('recomLabel');
        const memoLabel = document.getElementById('memoLabel');
        
        memoLabel.innerText = "ê°€ì¡±ë“¤ì˜ ìƒì„¸ ë©”ëª¨";

        if(cat === 'ìˆ™ì†Œ') {
            nameLabel.innerText = 'ìˆ™ì†Œëª…'; 
            recomLabel.innerText = 'í˜¸í…” ë“±ê¸‰(ì„±ê¸‰)';
        } else if(cat === 'ë¡œì»¬ ë§›ì§‘') {
            nameLabel.innerText = 'ìŒì‹ì (ì—…ì²´ëª…)'; 
            recomLabel.innerText = 'ì¶”ì²œ ë©”ë‰´ ë° ë§›';
        } else {
            nameLabel.innerText = 'ì¥ì†Œëª…(ê´€ê´‘ì§€)'; 
            recomLabel.innerText = 'í•œì¤„ ì¶”ì²œ/íŠ¹ì§•';
        }
    }

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            masterData = await res.json();
            updateFilters();
            runFilter();
        } catch (e) { document.getElementById('list-container').innerText = "ë¡œë“œ ì‹¤íŒ¨."; }
    }

    function updateFilters() {
        const nations = [...new Set(masterData.map(d => d.country))].sort();
        const regions = [...new Set(masterData.map(d => d.region))].sort();
        document.getElementById('fCou').innerHTML = '<option value="">êµ­ê°€</option>' + nations.map(n => `<option value="${n}">${n}</option>`).join('');
        document.getElementById('fReg').innerHTML = '<option value="">ì§€ì—­</option>' + regions.map(r => `<option value="${r}">${r}</option>`).join('');
    }

    function runFilter() {
        const sCat = document.getElementById('fCat').value;
        const sCou = document.getElementById('fCou').value;
        const sReg = document.getElementById('fReg').value;
        const sRat = document.getElementById('fRat').value;
        const sKey = document.getElementById('keyword').value.trim().toLowerCase();

        filteredData = masterData.filter(d => {
            const matchFilter = (!sCat || d.category === sCat) && (!sCou || d.country === sCou) && (!sReg || d.region === sReg) && (!sRat || parseInt(d.rating) >= parseInt(sRat));
            const matchSearch = !sKey || (d.title.toLowerCase().includes(sKey) || (d.info1 && d.info1.toLowerCase().includes(sKey)) || (d.info2 && d.info2.toLowerCase().includes(sKey)));
            return matchFilter && matchSearch;
        });
        page = 1;
        drawList();
    }

    function applyHighlight(text, keyword) {
        if (!keyword || !text) return text;
        const regex = new RegExp(`(${keyword})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function drawList() {
        const start = (page - 1) * limit;
        const end = start + limit;
        const items = filteredData.slice().reverse().slice(start, end);
        const container = document.getElementById('list-container');
        const sKey = document.getElementById('keyword').value.trim();

        if(filteredData.length === 0) { 
            container.innerHTML = "<p style='text-align:center; padding:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; 
            document.getElementById('pager').innerHTML = '';
            return; 
        }

        container.innerHTML = items.map((d, i) => {
            let tagClass = d.category === 'ë¡œì»¬ ë§›ì§‘' ? 'tag-food' : (d.category === 'ìˆ™ì†Œ' ? 'tag-stay' : 'tag-tour');
            let brief = d.info1 ? `(${d.info1.length > 12 ? d.info1.substring(0,12)+'...' : d.info1})` : '';
            let recomTitle = d.category === 'ìˆ™ì†Œ' ? 'í˜¸í…” ë“±ê¸‰(ì„±ê¸‰)' : (d.category === 'ë¡œì»¬ ë§›ì§‘' ? 'ì¶”ì²œ ë©”ë‰´ ë° ë§›' : 'í•œì¤„ ì¶”ì²œ/íŠ¹ì§•');

            return `
            <div class="post-item">
                <div class="post-header" onclick="toggleAccordion('detail-${i}')">
                    <div style="flex:1; min-width:0; display:flex; align-items:center; gap:10px;">
                        <span class="tag ${tagClass}">${d.category.split(' ')[1] || d.category}</span>
                        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <strong>${applyHighlight(d.title, sKey)}</strong> 
                            <span style="font-size:0.8rem; color:#718096;">${applyHighlight(brief, sKey)}</span>
                            <div style="font-size:0.8rem; color:#718096;">${d.country} Â· ${d.region}</div>
                        </div>
                    </div>
                    <div class="post-meta">
                        <div style="color:#f1c40f;">â­ ${d.rating}</div>
                        <div class="post-date">${d.date || ''}</div>
                    </div>
                </div>
                <div class="post-content" id="detail-${i}">
                    <div class="detail-card">
                        <span class="detail-label"><i class="fas fa-map-marked-alt"></i> ìƒì„¸ ì£¼ì†Œ</span>
                        ${d.address ? `
                            <a href="https://maps.google.com/?q=${encodeURIComponent(d.address)}" target="_blank" class="map-btn">
                                <i class="fas fa-location-dot"></i> ${d.address}
                            </a>
                        ` : '<div style="color:#a0aec0; font-size:0.9rem;">ì •ë³´ ì—†ìŒ</div>'}
                    </div>
                    <div class="detail-card">
                        <span class="detail-label"><i class="fas fa-star"></i> ${recomTitle}</span>
                        <div style="font-size:0.95rem;">${applyHighlight(d.info1, sKey) || '-'}</div>
                    </div>
                    <div class="detail-card">
                        <span class="detail-label"><i class="fas fa-comment-dots"></i> ê°€ì¡±ë“¤ì˜ ìƒì„¸ ë©”ëª¨</span>
                        <div style="white-space:pre-wrap; font-size:0.95rem;">${applyHighlight(d.info2, sKey) || '-'}</div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:10px;">
                        <button onclick="goEdit('${d.title.replace(/'/g, "\\'")}')" style="border:none; background:none; color:#718096; cursor:pointer;"><i class="fas fa-edit"></i> ìˆ˜ì •</button>
                        <button onclick="goDelete('${d.title.replace(/'/g, "\\'")}')" style="border:none; background:none; color:#ff7675; cursor:pointer;"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    </div>
                </div>
            </div>`;
        }).join('');
        drawPager();
    }

    function drawPager() {
        const total = Math.ceil(filteredData.length / limit);
        const pager = document.getElementById('pager');
        pager.innerHTML = '';
        if(total <= 1) return;
        for(let i=1; i<=total; i++) {
            const btn = document.createElement('button');
            btn.innerText = i; btn.className = `page-num ${i === page ? 'active' : ''}`;
            btn.onclick = () => { page = i; drawList(); window.scrollTo({top: 0, behavior: 'smooth'}); };
            pager.appendChild(btn);
        }
    }

    function toggleAccordion(id) {
        const el = document.getElementById(id);
        const isVisible = el.style.display === 'block';
        document.querySelectorAll('.post-content').forEach(c => c.style.display = 'none');
        el.style.display = isVisible ? 'none' : 'block';
    }

    document.getElementById('tripForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        btn.innerText = "ì²˜ë¦¬ ì¤‘..."; btn.disabled = true;
        const data = {
            category: document.getElementById('category').value,
            country: document.getElementById('country').value,
            region: document.getElementById('region').value,
            address: document.getElementById('address').value,
            title: document.getElementById('title').value,
            info1: document.getElementById('info1').value,
            info2: document.getElementById('info2').value,
            rating: document.getElementById('rating').value,
            date: new Date().toLocaleDateString()
        };
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: editMode ? 'edit' : 'add', targetTitle: editTarget, data: data }) });
        location.reload();
    };

    function goEdit(t) {
        event.stopPropagation();
        const d = masterData.find(item => item.title === t);
        document.getElementById('form-container').style.display = 'block';
        document.getElementById('btnToggle').innerHTML = '<i class="fas fa-times"></i> ì…ë ¥ì°½ ë‹«ê¸°';
        document.getElementById('category').value = d.category;
        updateLabel();
        document.getElementById('title').value = d.title;
        document.getElementById('country').value = d.country;
        document.getElementById('region').value = d.region;
        document.getElementById('address').value = d.address;
        document.getElementById('info1').value = d.info1;
        document.getElementById('info2').value = d.info2;
        document.getElementById('rating').value = d.rating;
        editMode = true; editTarget = t;
        document.getElementById('btnSubmit').innerText = "ë‚´ìš© ìˆ˜ì • ì™„ë£Œ";
        window.scrollTo(0,0);
    }

    async function goDelete(t) {
        event.stopPropagation();
        if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', targetTitle: t }) });
        location.reload();
    }

    loadData();
</script>
</body>
</html>